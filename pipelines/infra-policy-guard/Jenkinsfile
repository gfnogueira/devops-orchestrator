pipeline {
    agent {
        kubernetes {
            label 'devops-agent'
            defaultContainer 'jnlp'
            serviceAccount 'jenkins'
        }
    }

    environment {
        JENKINS_HOME_AGENT = '/home/jenkins/agent/workspace/infra-policy-guard/'
        PROJECT_BASE       = 'opentofu/environments/infra-cluster'
        POLICY_PATH        = "${JENKINS_HOME_AGENT}/${PROJECT_BASE}/policy"
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
        disableConcurrentBuilds()
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Discover Terraform Projects') {
            steps {
                script {
                    env.PROJECT_DIRS = sh(
                        script: "find ${env.PROJECT_BASE} -mindepth 1 -maxdepth 1 -type d -exec test -e '{}/main.tf' ';' -print",
                        returnStdout: true
                    ).trim().split("\n")
                    echo "Found Terraform directories:\n${env.PROJECT_DIRS.join('\n')}"
                }
            }
        }

        stage('Validate Each Terraform Project') {
            steps {
                script {
                    for (dir in env.PROJECT_DIRS) {
                        echo "\nüîç Running validations for: ${dir}"
                        dir(dir) {
                            stage("üìå RULE 1: TFLINT (${dir})") {
                                sh '''
                                    echo "[TFLINT] Initializing and linting..."
                                    tflint --init
                                    tflint --recursive
                                '''
                            }

                            stage("üìå RULE 2: Terraform Plan (${dir})") {
                                sh '''
                                    echo "[TOFU] Init and plan..."
                                    tofu init -input=false
                                    tofu plan -out=tfplan -input=false || true
                                    tofu show -json tfplan > tfplan.json

                                    echo "[TOFU] Resources in plan:"
                                    jq '.planned_values.root_module.resources // [] | .[] | {type: .type, name: .name}' tfplan.json || echo "‚ö†Ô∏è No resources found."
                                '''
                            }

                            stage("üìå RULE 3: Conftest Policy Check (${dir})") {
                                sh '''
                                    echo "[CONTEST] Listing files and path..."
                                    ls -la
                                    pwd

                                    echo "[CONFTEST] Summary (table format):"
                                    conftest test tfplan.json --policy ${POLICY_PATH} --output table || true

                                    echo "[CONFTEST] Trace (debug):"
                                    conftest test tfplan.json --policy ${POLICY_PATH} --trace || true
                                '''
                            }

                            stage("üìå RULE 4: Terraform Docs Validation (${dir})") {
                                sh '''
                                    echo "[TERRAFORM-DOCS] Checking README.md..."
                                    terraform-docs markdown table . > /tmp/generated.md

                                    if [ -f README.md ]; then
                                        if ! diff -q /tmp/generated.md README.md; then
                                            echo "‚ùå README.md is outdated. Please update it using terraform-docs."
                                            exit 1
                                        else
                                            echo "‚úÖ README.md is up-to-date."
                                        fi
                                    else
                                        echo "‚ö†Ô∏è No README.md found."
                                    fi
                                '''
                            }

                            stage("üìå RULE 5: TFSec Security Scan (${dir})") {
                                sh '''
                                    echo "[TFSEC] Scanning for security issues..."
                                    tfsec . || true
                                '''
                            }

                            stage("üìå RULE 6: Checkov Compliance Scan (${dir})") {
                                sh '''
                                    echo "[CHECKOV] Running policy scan..."
                                    checkov -d . --quiet || true
                                '''
                            }

                            stage("üìå RULE 7: OPA Evaluation (${dir})") {
                                sh '''
                                    echo "[OPA] Running manual policy check..."
                                    opa eval --format=pretty --input tfplan.json --data ${POLICY_PATH} "data.main.deny" || true
                                '''
                            }

                            echo "‚úÖ Finished validations for: ${dir}\n"
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo '‚úÖ All Terraform validations passed!'
        }
        failure {
            echo '‚ùå One or more validations failed!'
        }
    }
}